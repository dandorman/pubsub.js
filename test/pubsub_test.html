<!doctype html>

<html>
  <head>
    <meta charset="utf-8">
    <title>Pubsub Tests</title>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <link rel="stylesheet" href="mocha.css">
    <script src="chai.js"></script>
    <script src="mocha.js"></script>
    <script>mocha.setup('bdd');</script>
    <script src="require.js"></script>
    <script>
      $(function() {
        'use strict';

        require.config({
          urlArgs: "bust=" + (new Date()).getTime()
        });

        require(['../pubsub/pubsub.js'], function(pubsub) {
          var expect = chai.expect,
              publish = pubsub.publish,
              subscribe = pubsub.subscribe,
              unsubscribe = pubsub.unsubscribe;

          describe("publish", function() {
            it("notifies subscribers when events are published", function(done) {
              var obj = {}, notified = false;

              subscribe(obj, 'foo', function() {
                notified = true;
              });

              publish.call(obj, 'foo');

              setTimeout(function() {
                expect(notified).to.be.true;
                done();
              }, 0);
            });

            it("includes the publishing object as the first argument to the callback", function(done) {
              var obj = {};

              subscribe(obj, 'foo', function(a) {
                expect(a).to.equal(obj);
                done();
              });

              publish.call(obj, 'foo');
            });
          });

          describe("subscribe", function() {
            it("adds the subscribed callbacks to the object's subscribers", function() {
              var obj = {},
                  subscriber = function() {};

              var subscription = subscribe(obj, 'foo', subscriber);

              expect(obj._subscribers['foo']).to.have.property(subscription.toString());
              expect(obj._subscribers['foo'][subscription]).to.equal(subscriber);
            });

            it("binds the callback to the calling object when called from an object that is not the global object", function(done) {
              var publisher = {},
                  subscriber = {};

              subscribe.call(subscriber, publisher, 'foo', function() {
                expect(this).to.equal(subscriber);
                done();
              });

              publish.call(publisher, 'foo');
            });

            describe("subscriptions", function() {
              it("returns an integer representing the subscription", function() {
                var subscription = subscribe({}, 'foo', function() {});

                expect(subscription).to.be.a('number');
              });

              it("is unique to each subscription", function() {
                var a_subscription = subscribe({}, 'foo', function() {}),
                    another_subscription = subscribe({}, 'bar', function() {});

                expect(a_subscription).to.not.equal(another_subscription);
              });
            });

            it("replaces existing callbacks if a duplicate subscription is made", function(done) {
              var publisher = {},
                  subscriber = {},
                  flag_one = false, flag_two = false;

              subscribe.call(subscriber, publisher, 'foo', function() { flag_one = true });
              subscribe.call(subscriber, publisher, 'foo', function() { flag_two = true });
              publish.call(publisher, 'foo');

              setTimeout(function() {
                expect(flag_one).to.be.false;
                expect(flag_two).to.be.true;
                done();
              }, 0);
            });

          });

          describe("unsubscribe", function() {
            describe("when given a subscription key", function() {
              it("does not call the subscribed callback when notified", function(done) {
                var obj = {},
                    notified = false;

                var subscription = subscribe(obj, 'foo', function() { notified = true; });
                unsubscribe(subscription);

                publish.call(obj, 'foo');
                setTimeout(function() {
                  expect(notified).to.be.false;
                  done();
                });
              });
            });

            describe("when called from an object that is not the global object, and given an object and an event name", function() {
              it("unsubscribes the calling object from the target object's event", function(done) {
                var publisher = {},
                    subscriber = {},
                    notified = false;

                subscribe.call(subscriber, publisher, 'foo', function() { notified = true; });
                unsubscribe.call(subscriber, publisher, 'foo');

                publish.call(publisher, 'foo');
                setTimeout(function() {
                  expect(notified).to.be.false;
                  done();
                });
              });
            });
          });

          mocha.run();
        });
      });
    </script>
  </head>
  <body>
    <div id="mocha"></div>
  </body>
</html>
